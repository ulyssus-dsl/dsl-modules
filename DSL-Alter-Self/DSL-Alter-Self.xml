<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE MudletPackage>
<MudletPackage version="1.001">
	<TriggerPackage />
	<TimerPackage />
	<AliasPackage />
	<ActionPackage />
	<ScriptPackage>
		<Script isActive="yes" isFolder="no">
			<name>DSL-Alter-Self</name>
			<packageName></packageName>
			<script>dsl = dsl or {}
dsl.alterself = dsl.alterself or {}
dsl.alterself.aliases = dsl.alterself.aliases or {}
dsl.alterself.triggers = dsl.alterself.triggers or {}
dsl.alterself.eventHandlers = dsl.alterself.eventHandlers or {}
dsl.alterself.affectDataEventHandler = dsl.alterself.affectDataEventHandler or nil
dsl.alterself.addAffectEventHandler = dsl.alterself.addAffectEventHandler or nil
dsl.alterself.removeAffectEventHandler = dsl.alterself.removeAffectEventHandler or nil
dsl.alterself.loginDataEventHandler = dsl.alterself.loginDataEventHandler or nil
dsl.alterself.classTrigger = dsl.alterself.classTrigger or nil
dsl.alterself.uninstallHandler = dsl.alterself.uninstallHandler or nil
dsl.alterself.state = dsl.alterself.state or {
  enabled = false,
  isAltered = false,
  currentClass = nil,
  mob = nil,
  retries = 0,
  lastFighting = nil,
  debug = false
}

function dsl.alterself.send(cmd, show)
  if show == nil then
    show = true
  end
  
  if not show then
    dsl.alterself.debug("Sending command - " .. cmd)
  end
  
  if gmcp and gmcp.char_data and not gmcp.char_data.is_afk then
    send(cmd, show)
  end
end

function dsl.alterself.echo(msg)
  cecho("\n&lt;white&gt;[&lt;cyan&gt;Alter-Self&lt;white&gt;]&lt;green&gt; " ..msg .."&lt;reset&gt;\n")
end

function dsl.alterself.debug(msg)
  if dsl.alterself.state.debug then
    cecho("\n&lt;white&gt;[&lt;cyan&gt;Alter-Self&lt;white&gt;]&lt;red&gt; DEBUG: " ..msg .."&lt;reset&gt;\n")
  end
end

function dsl.alterself.deleteLine()
  local currentLine = getCurrentLine()
  deleteLine()
  dsl.autoregen.debug("Deleted line - " ..currentLine)
end

function dsl.alterself.killTempResources()
  dsl.alterself.debug("Killing all temporary resources")
  
  for _, triggerId in pairs(dsl.alterself.triggers) do 
    killTrigger(triggerId) 
  end
  dsl.alterself.triggers = {}
  
  for _, handlerId in pairs(dsl.alterself.eventHandlers) do
  	 killAnonymousEventHandler(handlerId)
  end
  dsl.alterself.eventHandlers = {}
end

function dsl.alterself.createTrigger(substring, func) 
  table.insert(dsl.alterself.triggers, tempTrigger(substring, func)) 
end

function dsl.alterself.createRegexTrigger(regex, func) 
  table.insert(dsl.alterself.triggers, tempRegexTrigger(regex, func)) 
end

function dsl.alterself.createAlias(alias, func)
	dsl.alterself.aliases[alias] = tempAlias("^" .. alias .. "$", func)
end

function dsl.alterself.doAlter(force)
  if gmcp.char_data.is_afk then
    dsl.alterself.debug("Not altering - AFK")
    return
  end
  
  if gmcp.char_data.is_fighting then
    dsl.alterself.debug("Not altering - fighting")
    return
  end
  
  if gmcp.char_data.mana &lt; 35 then
    dsl.alterself.debug("Not altering - not enough mana")
    return
  end
  
  if not force
    and dsl.alterself.state.lastFighting ~= nil
    and os.difftime(os.time(), dsl.alterself.state.lastFighting) &lt; 30 then
    dsl.alterself.debug("Not altering - fighting detected in last 30 seconds")
    return
  end
  
  if not dsl.alterself.state.enabled then
    dsl.alterself.debug("Not altering - not enabled")
    return
  end
  
  if dsl.alterself.state.isAltered then
    dsl.alterself.debug("Not altering - already altered")
    return
  end
  
  if not force
    and dsl.alterself.state.retries &gt;= 5 then
    dsl.alterself.debug("Not altering - exceeded 5 retries")
    return
  end

  dsl.alterself.send("c 'alter self' " ..dsl.alterself.state.mob)
end

-- Temporary triggers and handlers that will only be created
-- when in the auto regen room, otherwise these are removed
function dsl.alterself.createTempResources()
  dsl.alterself.killTempResources()
  dsl.alterself.debug("Creating all temporary resources")
  
  dsl.alterself.createTrigger(
    "Something is preventing you from doing so.", 
    function()
      selectString("Something is preventing you from doing so.", 1)
			fg("red")
			resetFormat()
      dsl.alterself.state.retries = dsl.alterself.state.retries + 1
      dsl.alterself.debug("Failed. Incrementing retries to " ..dsl.alterself.state.retries)
      dsl.alterself.doAlter()
    end)
    
  dsl.alterself.createTrigger(
		"Your body shudders in slight pain as your new features take shape.",
    function()
      selectString("Your body shudders in slight pain as your new features take shape.", 1)
			fg("green")
			resetFormat()
    end)
   
  dsl.alterself.eventHandlers.tick = registerAnonymousEventHandler(
    "gmcp.tick", 
    function()
      dsl.alterself.debug("TICK")
      dsl.alterself.state.retries = 0
      dsl.alterself.doAlter()
    end)
   
  dsl.alterself.eventHandlers.char_data = registerAnonymousEventHandler(
    "gmcp.char_data", 
    function()
      if gmcp.char_data.is_fighting then
        dsl.alterself.state.lastFighting = os.time()
      end
    end)
end

function dsl.alterself.enable(force)
  if dsl.alterself.state.mob ~= nil
    and dsl.alterself.state.mob ~= "" then
    dsl.alterself.echo("Alter-Self is Enabled: " ..dsl.alterself.state.mob)
    dsl.alterself.state.enabled = true
    dsl.alterself.state.retries = 0
    dsl.alterself.state.sleeping = false
    dsl.alterself.createTempResources()
    dsl.alterself.doAlter(force)
  else
    dsl.alterself.echo("Unable to enable - no mob set. Use &lt;cyan&gt;alterself &lt;mob&gt;&lt;green&gt; or &lt;cyan&gt;aself &lt;mob&gt;")
  end
end

-- Setup the core aliases and event handlers required
-- for the Alter-Self script to function.
-- Setup only occurs if the logged in character is
-- a valid Transmuter
function dsl.alterself.setupScript()
  dsl.alterself.echo("Valid class " ..dsl.alterself.state.currentClass .. ". Setting up script resources")
  
  dsl.alterself.createAlias("(aself|alterself)\\s?(.*)?", function()
    if matches[3] == "debug" then
      if dsl.alterself.state.debug then
        dsl.alterself.state.debug = false
        dsl.alterself.echo("Debug mode disabled")
      else
        dsl.alterself.state.debug = true
        dsl.alterself.echo("Debug mode enabled")
      end
    elseif matches[3] ~= nil and matches[3] ~= "" then
      dsl.alterself.state.mob = matches[3]:gsub("^%s*", "")
      dsl.alterself.enable(true)
    else
      if dsl.alterself.state.enabled then
        dsl.alterself.echo("Alter-Self is Disabled")
        dsl.alterself.killTempResources()
        dsl.alterself.state.enabled = false
      else
        dsl.alterself.enable()
      end
    end
  end)
  
  -- Keep track of alter self affect
  if dsl.alterself.affectDataEventHandler ~= nil then
  	 killAnonymousEventHandler(dsl.alterself.affectDataEventHandler)
  end
  
  dsl.alterself.affectDataEventHandler = registerAnonymousEventHandler(
    "gmcp.affect_data", 
    function()
      	for _, affect in pairs(gmcp.affect_data.affects) do
      		if affect.n == "alter self" then
            dsl.alterself.debug("alter self affect is currently on")
            dsl.alterself.state.isAltered = true
          end
      	end
    end)
  
  if dsl.alterself.addAffectEventHandler ~= nil then
  	 killAnonymousEventHandler(dsl.alterself.addAffectEventHandler)
  end
  
  dsl.alterself.addAffectEventHandler = registerAnonymousEventHandler(
    "gmcp.add_affect", 
    function()
    	if gmcp.add_affect.n == "alter self" then
        dsl.alterself.debug("alter self affect added")
        dsl.alterself.state.isAltered = true
      end
    end)
  
  if dsl.alterself.removeAffectEventHandler ~= nil then
  	 killAnonymousEventHandler(dsl.alterself.removeAffectEventHandler)
  end
  
  dsl.alterself.removeAffectEventHandler = registerAnonymousEventHandler(
    "gmcp.remove_affect", 
    function()
    	if gmcp.remove_affect.n == "alter self" then
        dsl.alterself.debug("alter self affect removed")
        dsl.alterself.state.isAltered = false
        dsl.alterself.doAlter()
      end
    end)
end

function dsl.alterself.teardownScript()
  dsl.alterself.debug("Tearing down script resources")
  
  for _, aliasId in pairs(dsl.alterself.aliases) do
  	 killAlias(aliasId)
  end
  dsl.alterself.aliases = {}
  
  if dsl.alterself.affectDataEventHandler ~= nil then
  	 killAnonymousEventHandler(dsl.alterself.affectDataEventHandler)
  end
  dsl.alterself.affectDataEventHandler = nil
  
  if dsl.alterself.addAffectEventHandler ~= nil then
  	 killAnonymousEventHandler(dsl.alterself.addAffectEventHandler)
  end
  dsl.alterself.addAffectEventHandler = nil
  
  if dsl.alterself.removeAffectEventHandler ~= nil then
  	 killAnonymousEventHandler(dsl.alterself.removeAffectEventHandler)
  end
  dsl.alterself.removeAffectEventHandler = nil
end

function dsl.alterself.isValidClass()
  return dsl.alterself.state.currentClass == 'Tra'
end

-- Setup the script if we have gmcp and a valid
-- Conclave Transmuter class
function dsl.alterself.setupIfNeeded()
  dsl.alterself.teardownScript()
  
  if gmcp ~= nil and gmcp.login_data ~= nil
    and dsl.alterself.isValidClass() then
    dsl.alterself.setupScript()
    
    if dsl.alterself.state.enabled then
      dsl.alterself.debug("Alter-Self is currently enabled")
      dsl.alterself.enable()
    else
      dsl.alterself.debug("Alter-Self is currently disabled")
    end
  else
    dsl.alterself.echo("Invalid class " ..dsl.alterself.state.currentClass .. ". Not setting up script resources")
  end
end

function dsl.alterself.checkCharacter()
  if dsl.alterself.classTrigger ~= nil then
    killTrigger(dsl.alterself.classTrigger)
  end
  
  dsl.alterself.classTrigger = tempRegexTrigger(
    "\\[\\s*?(?&lt;level&gt;[0-9]+)(\\s*[a-zA-Z-]+\\s)?\\s*(?&lt;class&gt;[a-zA-Z]+)](.*)" .. gmcp.login_data.name .."(.*)",
    function()
      dsl.alterself.deleteLine()
      dsl.alterself.debug("Found character. Detected class " ..matches.class)
      dsl.alterself.state.currentClass = matches.class
      killTrigger(dsl.alterself.classTrigger)
      dsl.alterself.setupIfNeeded()
    end)
    
  dsl.alterself.state.currentClass = nil
  dsl.alterself.echo("Checking current character's class")
  dsl.alterself.send("whois " ..gmcp.login_data.name, false)
end

if dsl.alterself.loginDataEventHandler ~= nil then
	 killAnonymousEventHandler(dsl.alterself.loginDataEventHandler)
end

dsl.alterself.loginDataEventHandler = registerAnonymousEventHandler(
  "gmcp.login_data", dsl.alterself.checkCharacter)
  
if dsl.alterself.uninstallHandler ~= nil then
	 killAnonymousEventHandler(dsl.alterself.uninstallHandler)
end
  
dsl.alterself.uninstallHandler = registerAnonymousEventHandler("sysUninstall", function(_, packageName)
	if packageName == "DSL-Alter-Self" then
    if dsl.alterself.loginDataEventHandler ~= nil then
      killAnonymousEventHandler(dsl.alterself.loginDataEventHandler)
    end

    dsl.alterself.killTempResources()
    dsl.alterself.teardownScript()
    dsl.alterself = nil
	end
end)
  
dsl.alterself.echo("Alter-Self Version 1.0.0 Loaded"
  .."\n&lt;white&gt;[&lt;cyan&gt;Alter-Self&lt;white&gt;]&lt;green&gt; Type &lt;cyan&gt;alterself &lt;mob&gt;&lt;green&gt; or &lt;cyan&gt;aself &lt;mob&gt;&lt;green&gt; to set the mob to alter to"
  .."\n&lt;white&gt;[&lt;cyan&gt;Alter-Self&lt;white&gt;]&lt;green&gt; Type &lt;cyan&gt;alterself&lt;green&gt; or &lt;cyan&gt;aself&lt;green&gt; to enable/disable"
  .."\n&lt;white&gt;[&lt;cyan&gt;Alter-Self&lt;white&gt;]&lt;green&gt; Type &lt;cyan&gt;alterself debug&lt;green&gt; or &lt;cyan&gt;aself debug&lt;green&gt; to toggle debug mode"
  )

if gmcp ~= nil and gmcp.login_data ~= nil then
  dsl.alterself.checkCharacter()
end</script>
			<eventHandlerList />
		</Script>
	</ScriptPackage>
	<KeyPackage />
	<HelpPackage>
		<helpURL></helpURL>
	</HelpPackage>
</MudletPackage>
